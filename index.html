<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>STAN</title>

  <meta name="theme-color" content="#0B0F1A" />
  <link rel="manifest" href="manifest.json" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="STAN" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root{
      --bg:#070A12;
      --bg2:#0B0F1A;
      --surface: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.10);
      --text:#EAF0FF;
      --muted: rgba(234,240,255,0.72);
      --muted2: rgba(234,240,255,0.55);
      --a1:#7B5CFF;
      --a2:#B256FF;
      --good:#45D483;
      --warn:#F0C04A;
      --r: 22px;
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 700px at 65% 18%, rgba(178,86,255,0.22), transparent 60%),
        radial-gradient(900px 520px at 22% 70%, rgba(123,92,255,0.18), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      padding: 22px 16px 40px;
      padding-top: max(22px, env(safe-area-inset-top));
      padding-bottom: max(40px, env(safe-area-inset-bottom));
    }

    .wrap{ max-width: 560px; margin:0 auto; }
    .title{
      font-size:56px;
      line-height:0.95;
      font-weight:900;
      letter-spacing:0.5px;
      margin: 6px 0 8px;
      text-shadow: 0 18px 50px rgba(0,0,0,0.35);
    }
    .subtitle{
      margin:0 0 18px;
      color:var(--muted2);
      font-size:18px;
    }

    .hero{
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
      padding: 16px;
    }

    .heroTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    .heroTop h3{
      margin:0;
      font-size:22px;
      letter-spacing:0.2px;
    }
    .pill{
      padding:10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      color: rgba(234,240,255,0.85);
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
    }

    /* AVATAR BOX (bez bia≈Çej ramki, profesjonalnie) */
    .avatarBox{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: calc(var(--r) - 6px);
      border: 1px solid rgba(255,255,255,0.12);
      background:
        radial-gradient(650px 420px at 50% 40%, rgba(178,86,255,0.22), rgba(0,0,0,0.10)),
        radial-gradient(800px 520px at 50% 110%, rgba(123,92,255,0.16), transparent 60%),
        rgba(0,0,0,0.22);
      position: relative;
      overflow: hidden;
      margin-bottom: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-user-select:none;
      touch-action: manipulation;
    }

    /* ORB (CSS ‚Äì zawsze dzia≈Ça) */
    .orb{
      width: 78%;
      aspect-ratio:1/1;
      border-radius: 999px;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,0.18), transparent 40%),
        radial-gradient(circle at 55% 55%, rgba(178,86,255,0.58), transparent 55%),
        radial-gradient(circle at 50% 55%, rgba(123,92,255,0.35), transparent 60%),
        radial-gradient(circle at 50% 50%, rgba(0,0,0,0.28), rgba(0,0,0,0.55));
      box-shadow:
        0 0 80px rgba(123,92,255,0.35),
        0 0 140px rgba(178,86,255,0.18),
        inset 0 0 35px rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.12);
      position:relative;
      transform: translateZ(0);
      animation: orbBreath 4.6s ease-in-out infinite;
    }
    .orb::after{
      content:"";
      position:absolute;
      left:-10%;
      right:-10%;
      top:50%;
      height:3px;
      background: linear-gradient(90deg, transparent, rgba(234,240,255,0.35), transparent);
      box-shadow: 0 0 18px rgba(178,86,255,0.55);
      opacity:0.85;
      animation: scan 3.8s ease-in-out infinite;
    }
    @keyframes orbBreath{
      0%,100%{ transform: scale(1.00); filter:saturate(1.05); }
      50%{ transform: scale(1.02); filter:saturate(1.2); }
    }
    @keyframes scan{
      0%,100%{ transform: translateY(-14px); opacity:0.55; }
      50%{ transform: translateY(10px); opacity:0.95; }
    }

    /* SEMI (PNG) ‚Äì bez ramki, z mikro-≈ºyciem (parallax + glow) */
    .semiWrap{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 10px;
    }
    .semiImg{
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: calc(var(--r) - 10px);
      display:block;
      border: none;              /* usuwa ‚Äûramkƒô‚Äù */
      outline: none;
      box-shadow:
        0 0 0 0 rgba(0,0,0,0),
        0 18px 70px rgba(0,0,0,0.55);
      transform: translate3d(0,0,0) scale(1.02);
      filter: saturate(1.08) contrast(1.02);
      animation: semiBreath 5.2s ease-in-out infinite;
      background: transparent;
    }
    @keyframes semiBreath{
      0%,100%{ transform: translate3d(0,0,0) scale(1.02); }
      50%{ transform: translate3d(0,-2px,0) scale(1.03); }
    }

    .glowCircuit{
      pointer-events:none;
      position:absolute;
      inset:-20%;
      background:
        radial-gradient(closest-side at 50% 45%, rgba(178,86,255,0.18), transparent 65%),
        radial-gradient(closest-side at 40% 60%, rgba(123,92,255,0.10), transparent 70%),
        conic-gradient(from 90deg, rgba(178,86,255,0.0), rgba(178,86,255,0.08), rgba(123,92,255,0.0));
      mix-blend-mode: screen;
      opacity: 0.55;
      animation: circuit 9s linear infinite;
    }
    @keyframes circuit{
      0%{ transform: rotate(0deg) scale(1); opacity:0.45; }
      50%{ transform: rotate(180deg) scale(1.03); opacity:0.70; }
      100%{ transform: rotate(360deg) scale(1); opacity:0.45; }
    }

    textarea{
      width:100%;
      min-height: 122px;
      resize: vertical;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      padding: 14px;
      font-size:16px;
      line-height:1.35;
      outline:none;
    }
    textarea::placeholder{ color: rgba(234,240,255,0.50); }

    .btn{
      width:100%;
      margin-top:12px;
      border:none;
      border-radius: 18px;
      padding: 16px 18px;
      font-size:20px;
      font-weight:900;
      color:white;
      background: linear-gradient(90deg, var(--a1), var(--a2));
      box-shadow: 0 18px 50px rgba(123,92,255,0.35);
      cursor:pointer;
    }
    .btn:active{ transform: translateY(1px); }

    .row{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .smallBtn{
      flex:1;
      border-radius: 16px;
      padding: 12px 14px;
      background: rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.10);
      color: rgba(234,240,255,0.85);
      font-weight:900;
      cursor:pointer;
    }
    .smallBtn.primary{
      background: linear-gradient(90deg, rgba(123,92,255,0.50), rgba(178,86,255,0.45));
      border-color: rgba(255,255,255,0.14);
    }

    .chips{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      font-size:13px;
      color: rgba(234,240,255,0.80);
      padding: 9px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
      backdrop-filter: blur(10px);
    }
    .chip.good{ border-color: rgba(69,212,131,0.35); }
    .chip.warn{ border-color: rgba(240,192,74,0.35); }

    .grid{
      margin-top:16px;
      display:grid;
      gap:12px;
    }
    .card{
      border-radius: 20px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
      padding: 16px;
    }
    .card h3{
      margin:0 0 8px;
      font-size: 24px;
      letter-spacing:0.2px;
    }
    .card .text{
      margin:0;
      color: rgba(234,240,255,0.74);
      font-size: 16px;
      line-height:1.45;
      white-space: pre-wrap;
    }

    /* Paywall overlay */
    .overlay{
      position: fixed;
      inset:0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 18px;
      padding-bottom: max(18px, env(safe-area-inset-bottom));
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(10px);
      z-index: 50;
    }
    .sheet{
      width:min(560px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,0.14);
      background: linear-gradient(180deg, rgba(15,18,32,0.96), rgba(7,10,18,0.96));
      box-shadow: 0 30px 80px rgba(0,0,0,0.65);
      padding: 16px;
    }
    .sheet h4{
      margin:0 0 6px;
      font-size:18px;
    }
    .sheet p{
      margin:0 0 12px;
      color: rgba(234,240,255,0.72);
      line-height:1.35;
      font-size:14px;
    }
    .sheet .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .buyBtn{
      flex:1;
      min-width: 180px;
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 950;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      color: rgba(234,240,255,0.88);
      cursor:pointer;
    }
    .buyBtn.pro{
      background: linear-gradient(90deg, rgba(123,92,255,0.55), rgba(178,86,255,0.52));
      border-color: rgba(255,255,255,0.16);
      color:#fff;
    }
    .ghostBtn{
      width:100%;
      margin-top:10px;
      background: transparent;
      border: 1px dashed rgba(255,255,255,0.18);
      color: rgba(234,240,255,0.70);
      border-radius: 16px;
      padding: 11px 12px;
      font-weight: 900;
      cursor:pointer;
    }

    /* Footer */
    footer{
      margin-top: 16px;
      color: rgba(234,240,255,0.45);
      font-size: 12px;
      line-height: 1.35;
      padding: 6px 4px 0;
    }
    footer strong{ color: rgba(234,240,255,0.62); }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .orb, .orb::after, .semiImg, .glowCircuit{ animation:none !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">STAN</div>
    <div class="subtitle">Agent decyzyjny AI ‚Ä¢ obecno≈õƒá</div>

    <div class="hero">
      <div class="heroTop">
        <h3>STAN avatar</h3>
        <div class="pill" id="avatarPill">Domy≈õlnie: ORB</div>
      </div>

      <div class="avatarBox" id="avatarBox" aria-label="STAN avatar">
        <div class="orb" id="orb" aria-label="STAN orb"></div>

        <div class="semiWrap" id="semiWrap" aria-label="STAN semi">
          <img class="semiImg" id="semiImg" src="avatar-semi.PNG" alt="STAN semi-human" />
          <div class="glowCircuit" aria-hidden="true"></div>
        </div>
      </div>

      <textarea id="input" placeholder="Opisz sytuacjƒô. Co siƒô sta≈Ço, co chcesz osiƒÖgnƒÖƒá, jakie masz ograniczenia?"></textarea>

      <button class="btn" id="analyzeBtn">Analiza ‚Üí</button>

      <div class="row">
        <button class="smallBtn primary" id="listenBtn">üéôÔ∏è S≈Çuchaj</button>
        <button class="smallBtn" id="speakBtn">üîä M√≥w</button>
        <button class="smallBtn" id="ambientBtn">üå´Ô∏è Ambient</button>
        <button class="smallBtn" id="stopBtn">‚õî Stop</button>
      </div>

      <div class="chips">
        <div class="chip warn" id="modeChip">Tryb: CORE (Hard)</div>
        <div class="chip good" id="pwaChip">PWA: ‚Äî</div>
        <div class="chip" id="voiceChip">Audio: ‚Äî</div>
        <div class="chip" id="verChip">Wersja: PRO</div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Analiza</h3>
          <p class="text" id="analysis">Tu pojawi siƒô analiza.</p>
        </div>
        <div class="card">
          <h3>Ryzyko</h3>
          <p class="text" id="risk">Tu pojawi siƒô ocena ryzyka.</p>
        </div>
        <div class="card">
          <h3>Rekomendacja</h3>
          <p class="text" id="recommendation">Tu pojawi siƒô rekomendacja.</p>
        </div>
      </div>

      <footer>
        <div><strong>¬© 2026 STAN ‚Äî Wszelkie prawa zastrze≈ºone.</strong></div>
        <div>STAN generuje odpowiedzi automatycznie. Nie stawia diagnoz i nie zastƒôpuje specjalisty. W razie problem√≥w zdrowotnych/prawnych/finansowych skonsultuj siƒô z profesjonalistƒÖ.</div>
      </footer>
    </div>
  </div>

  <!-- Paywall -->
  <div class="overlay" id="unlockOverlay" aria-hidden="true">
    <div class="sheet">
      <h4>Odblokuj STAN</h4>
      <p>To wersja premium. Wybierz plan i doko≈Ñcz zakup w Stripe. Potem wr√≥ƒá tutaj.</p>
      <div class="actions">
        <button class="buyBtn" id="unlockNoAmbientBtn">Kup STAN (29 z≈Ç)</button>
        <button class="buyBtn pro" id="unlockBtn">Kup STAN PRO (39 z≈Ç)</button>
      </div>
      <button class="ghostBtn" id="closeOverlayBtn">Nie teraz</button>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const analyzeBtn = $("analyzeBtn");
    const input = $("input");
    const analysis = $("analysis");
    const risk = $("risk");
    const recommendation = $("recommendation");

    const avatarBox = $("avatarBox");
    const orbEl = $("orb");
    const semiWrap = $("semiWrap");
    const semiImg = $("semiImg");
    const avatarPill = $("avatarPill");

    const listenBtn = $("listenBtn");
    const speakBtn = $("speakBtn");
    const ambientBtn = $("ambientBtn");
    const stopBtn = $("stopBtn");

    const pwaChip = $("pwaChip");
    const voiceChip = $("voiceChip");

    const unlockOverlay = $("unlockOverlay");
    const unlockBtn = $("unlockBtn");
    const unlockNoAmbientBtn = $("unlockNoAmbientBtn");
    const closeOverlayBtn = $("closeOverlayBtn");

    // ========= STRIPE LINKS (WSTAW SWOJE) =========
    const STAN_LINK = https://buy.stripe.com/6oU7sNeke6jE2Ym5GS8og03 ;
    const STAN_PRO_LINK = https://buy.stripe.com/9B6dRbb828rMgPc6KW8og02 ;

    // ========= PWA detect =========
    function isStandalonePWA(){
      return window.matchMedia("(display-mode: standalone)").matches
        || window.navigator.standalone === true;
    }
    function setPwaChip(){
      pwaChip.textContent = "PWA: " + (isStandalonePWA() ? "TAK" : "NIE");
    }

    // ========= Avatar switch (long press) =========
    let avatarMode = localStorage.getItem("stan_avatar") || "orb"; // orb | semi
    function renderAvatar(){
      if(avatarMode === "orb"){
        orbEl.style.display = "block";
        semiWrap.style.display = "none";
        avatarPill.textContent = "Domy≈õlnie: ORB";
      } else {
        orbEl.style.display = "none";
        semiWrap.style.display = "flex";
        avatarPill.textContent = "Premium: SEMI-HUMAN";
      }
    }
    function setAvatar(mode){
      avatarMode = mode;
      localStorage.setItem("stan_avatar", mode);
      renderAvatar();
    }

    let pressT = null;
    avatarBox.addEventListener("pointerdown", () => {
      pressT = setTimeout(() => {
        setAvatar(avatarMode === "orb" ? "semi" : "orb");
        pressT = null;
      }, 650); // ~0.65s
    });
    window.addEventListener("pointerup", () => { if(pressT) clearTimeout(pressT); pressT = null; });
    window.addEventListener("pointercancel", () => { if(pressT) clearTimeout(pressT); pressT = null; });

    // ========= ‚Äú≈ªywy‚Äù semi: patrzy w stronƒô palca/kursora (delikatnie) =========
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function onMove(e){
      if(avatarMode !== "semi") return;
      const r = avatarBox.getBoundingClientRect();
      const x = (("touches" in e && e.touches[0]) ? e.touches[0].clientX : e.clientX) - r.left;
      const y = (("touches" in e && e.touches[0]) ? e.touches[0].clientY : e.clientY) - r.top;
      const nx = (x / r.width - 0.5) * 2;
      const ny = (y / r.height - 0.5) * 2;

      const tx = clamp(nx * 6, -6, 6);
      const ty = clamp(ny * 6, -6, 6);

      semiImg.style.transform = `translate3d(${tx}px, ${ty}px, 0) scale(1.03)`;
    }
    avatarBox.addEventListener("mousemove", onMove, { passive:true });
    avatarBox.addEventListener("touchmove", onMove, { passive:true });
    avatarBox.addEventListener("mouseleave", () => {
      semiImg.style.transform = "translate3d(0,0,0) scale(1.02)";
    });

    // ========= Voice: Speech Synthesis (m√≥wienie) =========
    const canSpeak = "speechSynthesis" in window;
    let speakingUtterance = null;

    function pickPolishVoicePreferMale(){
      if(!canSpeak) return null;
      const voices = window.speechSynthesis.getVoices?.() || [];
      const pl = voices.filter(v => (v.lang || "").toLowerCase().startsWith("pl"));
      if(!pl.length) return null;
      // Heurystyka: czƒôsto mƒôskie g≈Çosy majƒÖ nazwƒô typu "Google polski" bez p≈Çci,
      // wiƒôc: preferuj takie, kt√≥re nie brzmiƒÖ "female" / "kobieta" / "Zosia" itd.
      const maleish = pl.find(v => !/female|kob|zosia|ewa|ania/i.test(v.name));
      return maleish || pl[0];
    }

    function speak(text){
      if(!canSpeak){
        voiceChip.textContent = "Audio: brak TTS";
        return;
      }
      window.speechSynthesis.cancel();

      const u = new SpeechSynthesisUtterance(text);
      u.lang = "pl-PL";
      u.rate = 1.02;
      u.pitch = 0.95;

      const v = pickPolishVoicePreferMale();
      if(v) u.voice = v;

      speakingUtterance = u;
      window.speechSynthesis.speak(u);
      voiceChip.textContent = "Audio: m√≥wiƒô";
    }

    // ========= Voice: Speech Recognition (s≈Çuchanie) =========
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let listening = false;
    const canListen = !!SR;

    function setVoiceChip(txt){ voiceChip.textContent = txt; }

    if(canListen){
      recognition = new SR();
      recognition.lang = "pl-PL";
      recognition.interimResults = true;
      recognition.continuous = true;

      recognition.onresult = (event) => {
        let finalText = "";
        let interimText = "";
        for(let i = event.resultIndex; i < event.results.length; i++){
          const t = event.results[i][0].transcript;
          if(event.results[i].isFinal) finalText += t;
          else interimText += t;
        }
        const merged = (finalText || interimText).trim();
        if(merged){
          input.value = merged;
        }
      };

      recognition.onstart = () => { listening = true; setVoiceChip("Mikrofon: s≈Çucham"); };
      recognition.onend = () => { listening = false; setVoiceChip("Audio: gotowe"); };
      recognition.onerror = () => { listening = false; setVoiceChip("Mikrofon: b≈ÇƒÖd"); };
    }

    // ========= Ambient (w wersji PRO) =========
    let audioCtx = null;
    let ambientOn = false;
    let ambientNodes = [];
    function stopAmbient(){
      try{
        ambientNodes.forEach(n => { try{ n.stop?.(); }catch(_){ } try{ n.disconnect?.(); }catch(_){ } });
        ambientNodes = [];
        if(audioCtx) audioCtx.close?.();
      }catch(_){}
      audioCtx = null;
      ambientOn = false;
    }

    function startAmbient(){
      stopAmbient();
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(!Ctx){
        setVoiceChip("Audio: brak WebAudio");
        return;
      }
      audioCtx = new Ctx();

      // r√≥≈ºnicowo: B + C = szum + powolne pulsacje (bez ‚Äûwiatru‚Äù)
      const noiseBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
      const data = noiseBuffer.getChannelData(0);
      for(let i=0;i<data.length;i++){
        data[i] = (Math.random()*2 - 1) * 0.18;
      }
      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;
      noise.loop = true;

      const noiseGain = audioCtx.createGain();
      noiseGain.gain.value = 0.035;

      const hp = audioCtx.createBiquadFilter();
      hp.type = "highpass";
      hp.frequency.value = 140;

      const lp = audioCtx.createBiquadFilter();
      lp.type = "lowpass";
      lp.frequency.value = 1200;

      // sub puls (bardzo delikatny)
      const osc = audioCtx.createOscillator();
      osc.type = "sine";
      osc.frequency.value = 55;

      const oscGain = audioCtx.createGain();
      oscGain.gain.value = 0.012;

      // LFO na g≈Ço≈õno≈õƒá (oddech)
      const lfo = audioCtx.createOscillator();
      lfo.type = "sine";
      lfo.frequency.value = 0.11;

      const lfoGain = audioCtx.createGain();
      lfoGain.gain.value = 0.55;

      lfo.connect(lfoGain);
      lfoGain.connect(noiseGain.gain);

      noise.connect(hp);
      hp.connect(lp);
      lp.connect(noiseGain);
      noiseGain.connect(audioCtx.destination);

      osc.connect(oscGain);
      oscGain.connect(audioCtx.destination);

      noise.start();
      osc.start();
      lfo.start();

      ambientNodes = [noise, osc, lfo, noiseGain, hp, lp, oscGain, lfoGain];
      ambientOn = true;
      setVoiceChip("Audio: ambient ON");
    }

    function setAmbient(on){
      if(on) startAmbient();
      else { stopAmbient(); setVoiceChip("Audio: ambient OFF"); }
    }

    function stopAllAudio(){
      if(canSpeak) window.speechSynthesis.cancel();
      if(recognition && listening){ try{ recognition.stop(); }catch(_){ } }
      stopAmbient();
      setVoiceChip("Audio: stop");
    }

    // ========= Paywall =========
    const unlocked = () => localStorage.getItem("stan_unlocked") === "1";
    function showUnlockOverlay(){
      unlockOverlay.style.display = "flex";
      unlockOverlay.setAttribute("aria-hidden", "false");
    }
    function hideUnlockOverlay(){
      unlockOverlay.style.display = "none";
      unlockOverlay.setAttribute("aria-hidden", "true");
    }

    // Klikniƒôcie = przekierowanie do Stripe
    unlockBtn.addEventListener("click", () => { window.location.href = STAN_PRO_LINK; });
    unlockNoAmbientBtn.addEventListener("click", () => { window.location.href = STAN_LINK; });
    closeOverlayBtn.addEventListener("click", hideUnlockOverlay);

    // ========= STAN CORE (fetch do backendu) =========
    async function run(){
      const t = input.value.trim();
      if(t.length < 40){
        analysis.textContent =
          "Zatrzymaj chaos.\n\nPodaj:\n" +
          "1) Cel\n" +
          "2) Ograniczenia\n" +
          "3) 2 opcje (A/B)\n\n" +
          "Nie zgadujƒô. Analizujƒô.";
        risk.textContent = "";
        recommendation.textContent = "";
        return;
      }

      // je≈õli nie odblokowane ‚Äì poka≈º overlay przy pr√≥bie AI/Audio premium
      if(!unlocked()){
        showUnlockOverlay();
        analysis.textContent = "üîí Ten tryb wymaga odblokowania (STAN / STAN PRO).";
        risk.textContent = "";
        recommendation.textContent = "";
        return;
      }

      analysis.textContent = "‚è≥ STAN analizuje‚Ä¶";
      risk.textContent = "‚è≥";
      recommendation.textContent = "‚è≥";

      try{
        const r = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ text: t, mode: "hardcore", persona: "stan" })
        });
        const data = await r.json();

        analysis.textContent = data.analysis || "Brak analizy.";
        risk.textContent = data.risk || "Brak.";
        recommendation.textContent = data.recommendation || "Brak.";
      }catch(e){
        analysis.textContent = "Nie mogƒô teraz doko≈Ñczyƒá analizy ‚Äî b≈ÇƒÖd sieci lub backendu.";
        risk.textContent = "B≈ÇƒÖd: sprawd≈∫ /api/analyze i ENV.";
        recommendation.textContent = "Je≈õli chcesz, poka≈º mi logi z Vercel (Runtime Logs).";
      }
    }

    // ========= Events =========
    analyzeBtn.addEventListener("click", run);

    listenBtn.addEventListener("click", () => {
      if(!unlocked()){ showUnlockOverlay(); return; }
      if(!canListen){
        setVoiceChip("Mikrofon: brak (iOS PWA czƒôsto nie wspiera)");
        return;
      }
      try{
        listening ? recognition.stop() : recognition.start();
      }catch(_){
        setVoiceChip("Mikrofon: ERROR");
      }
    });

    speakBtn.addEventListener("click", () => {
      if(!unlocked()){ showUnlockOverlay(); return; }
      const t = [analysis.textContent, risk.textContent, recommendation.textContent].join("\n\n");
      speak(t);
    });

    ambientBtn.addEventListener("click", () => {
      if(!unlocked()){ showUnlockOverlay(); return; }
      setAmbient(!ambientOn);
    });

    stopBtn.addEventListener("click", stopAllAudio);

    // init
    setPwaChip();
    renderAvatar();
    setTimeout(() => {
      setVoiceChip("Audio: gotowe (tap to unlock)");
    }, 350);

    // iOS: voices load async
    if(canSpeak){
      window.speechSynthesis.onvoiceschanged = () => {};
    }
  </script>
</body>
</html>