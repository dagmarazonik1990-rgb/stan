<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>STAN</title>

  <meta name="theme-color" content="#0B0F1A" />
  <link rel="manifest" href="manifest.json" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="STAN" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root{
      --bg:#070A12;
      --bg2:#0B0F1A;
      --surface: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.10);
      --text:#EAF0FF;
      --muted: rgba(234,240,255,0.72);
      --muted2: rgba(234,240,255,0.55);
      --a1:#7B5CFF;
      --a2:#B256FF;

      --r: 22px;
      --shadow: 0 18px 60px rgba(0,0,0,0.45);

      /* live avatar motion */
      --mx: 0;  /* -1..1 */
      --my: 0;  /* -1..1 */
      --idle: 0;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 65% 18%, rgba(178,86,255,0.18), transparent 60%),
        radial-gradient(900px 520px at 22% 70%, rgba(123,92,255,0.14), transparent 55%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      padding: 22px 16px 40px;
      padding-top: max(22px, env(safe-area-inset-top));
      padding-bottom: max(40px, env(safe-area-inset-bottom));
      overflow-x: hidden;
    }

    .wrap{ max-width:560px; margin:0 auto; }

    .title{
      font-size:56px;
      line-height:0.95;
      font-weight:900;
      letter-spacing:0.02em;
      margin:0;
    }
    .subtitle{
      margin:8px 0 18px;
      color:var(--muted2);
      font-size:18px;
    }

    .hero{
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
      padding: 16px;
    }

    .rowTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .rowTop h3{
      margin:0;
      font-size:22px;
      letter-spacing:0.01em;
    }
    .pill{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      color: rgba(234,240,255,0.78);
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
    }
    .pill.me{
      border-color: rgba(178,86,255,0.35);
      box-shadow: 0 0 0 1px rgba(123,92,255,0.12) inset;
    }

    .avatarBox{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: calc(var(--r) - 6px);
      border:1px solid rgba(255,255,255,0.12);
      background:
        radial-gradient(650px 420px at 50% 40%, rgba(178,86,255,0.22), transparent 60%),
        radial-gradient(800px 520px at 50% 110%, rgba(123,92,255,0.18), transparent 60%),
        rgba(0,0,0,0.22);
      position:relative;
      overflow:hidden;
      margin-bottom: 12px;

      display:flex;
      align-items:center;
      justify-content:center;

      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
      touch-action: manipulation;
    }

    .hint{
      position:absolute;
      left:50%;
      bottom:14px;
      transform:translateX(-50%);
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      color: rgba(234,240,255,0.72);
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(10px);
    }

    /* ORB */
    .orb{
      width:72%;
      aspect-ratio:1/1;
      border-radius:999px;
      position:relative;
      background:
        radial-gradient(circle at calc(35% + var(--mx)*6%) calc(30% + var(--my)*6%), rgba(255,255,255,0.22), transparent 35%),
        radial-gradient(circle at 50% 55%, rgba(178,86,255,0.55), rgba(123,92,255,0.28) 45%, rgba(0,0,0,0.35) 76%),
        radial-gradient(circle at 50% 50%, rgba(10,12,22,0.0), rgba(0,0,0,0.55) 70%);
      box-shadow:
        0 0 80px rgba(123,92,255,0.35),
        0 0 140px rgba(178,86,255,0.20),
        inset 0 0 35px rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.12);
      transform: translateY(calc(var(--idle) * 2px));
      animation: orbBreath 6.8s ease-in-out infinite;
      will-change: transform;
    }
    .orb::after{
      content:"";
      position:absolute;
      left:-10%;
      right:-10%;
      top:50%;
      height:3px;
      transform: translateY(-50%);
      background: linear-gradient(90deg, transparent, rgba(234,240,255,0.20), rgba(178,86,255,0.55), rgba(234,240,255,0.20), transparent);
      box-shadow: 0 0 18px rgba(178,86,255,0.55);
      opacity:0.85;
      animation: scan 4.2s ease-in-out infinite;
      border-radius:99px;
    }
    @keyframes scan{
      0%,100%{ opacity:0.55; filter: blur(0px); }
      50%{ opacity:0.95; filter: blur(0.2px); }
    }
    @keyframes orbBreath{
      0%,100%{ transform: translateY(calc(var(--idle) * 2px)) scale(1.00); }
      50%{ transform: translateY(calc(var(--idle) * 2px - 2px)) scale(1.015); }
    }

    /* SEMI */
    .semiWrap{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.18);
    }
    .semiImg{
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform:
        translate(calc(var(--mx) * 10px), calc(var(--my) * 8px))
        scale(1.10);
      filter: contrast(1.03) saturate(1.06);
      will-change: transform;
    }
    .semiVignette{
      position:absolute;
      inset:-1px;
      pointer-events:none;
      background:
        radial-gradient(120% 120% at 50% 30%, rgba(0,0,0,0.0) 45%, rgba(0,0,0,0.45) 100%),
        radial-gradient(70% 55% at 50% 100%, rgba(178,86,255,0.20), rgba(0,0,0,0.0) 55%);
      mix-blend-mode: multiply;
    }

    textarea{
      width:100%;
      min-height:112px;
      resize:vertical;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      padding: 14px;
      font-size: 16px;
      line-height: 1.35;
      outline:none;
    }
    textarea::placeholder{ color: rgba(234,240,255,0.55); }

    .btn{
      width:100%;
      margin-top:12px;
      border:none;
      border-radius:18px;
      padding: 16px 18px;
      font-size:20px;
      font-weight:900;
      color:white;
      background: linear-gradient(90deg, var(--a1), var(--a2));
      box-shadow: 0 18px 50px rgba(123,92,255,0.28);
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
    }
    .btn:active{ transform: translateY(1px); }

    .row{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .smallBtn{
      flex:1;
      border-radius:16px;
      padding: 12px 14px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(234,240,255,0.86);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
    }
    .smallBtn.primary{
      background: linear-gradient(90deg, rgba(123,92,255,0.35), rgba(178,86,255,0.25));
      border-color: rgba(255,255,255,0.14);
    }
    .smallBtn:active{ transform: translateY(1px); }

    .chips{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      font-size:13px;
      color: rgba(234,240,255,0.72);
      padding: 9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
      backdrop-filter: blur(10px);
    }
    .chip.good{ border-color: rgba(69,212,131,0.35); }
    .chip.warn{ border-color: rgba(240,192,74,0.35); }

    .grid{ margin-top:16px; display:grid; gap:12px; }
    .card{
      border-radius:20px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
      padding: 16px;
    }
    .card h3{ margin:0 0 8px; font-size:34px; }
    .card .text{
      margin:0;
      color: rgba(234,240,255,0.74);
      font-size:16px;
      line-height:1.42;
      white-space: pre-wrap;
    }

    /* unlock overlay */
    .unlockOverlay{
      position: fixed;
      inset: 0;
      z-index: 9999;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 18px 16px calc(18px + env(safe-area-inset-bottom));
      background: radial-gradient(900px 520px at 50% 30%, rgba(178,86,255,0.22), rgba(0,0,0,0.88) 70%);
      backdrop-filter: blur(10px);
    }
    .unlockPanel{
      width:min(560px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.38);
      box-shadow: 0 22px 80px rgba(0,0,0,0.55);
      padding: 16px;
    }
    .unlockPanel .h{
      font-size:18px;
      font-weight:900;
      margin:0 0 6px;
    }
    .unlockPanel .p{
      margin:0 0 12px;
      color: rgba(234,240,255,0.72);
      line-height:1.35;
      font-size:14px;
    }
    .unlockPanel .urow{
      display:flex;
      gap:10px;
    }
    .unlockPanel button{
      flex:1;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(234,240,255,0.9);
      padding: 12px 14px;
      font-weight:900;
      font-size:15px;
    }
    .unlockPanel button.primary{
      background: linear-gradient(90deg, rgba(123,92,255,0.55), rgba(178,86,255,0.45));
      border-color: rgba(255,255,255,0.14);
      color: white;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">STAN</div>
    <div class="subtitle" id="sub">Agent decyzyjny AI ‚Ä¢ obecno≈õƒá</div>

    <div class="hero">
      <div class="rowTop">
        <h3>STAN avatar</h3>
        <div class="pill me" id="avatarPill">Domy≈õlnie: ORB</div>
      </div>

      <div class="avatarBox" id="avatarBox" aria-label="STAN avatar">
        <div class="orb" id="orb"></div>

        <div class="semiWrap" id="semiWrap" style="display:none;">
          <img class="semiImg" id="semiImg" alt="STAN semi-human" />
          <div class="semiVignette"></div>
        </div>

        <div class="hint">Przytrzymaj 1s: prze≈ÇƒÖcz avatar ‚Ä¢ 2s: prze≈ÇƒÖcz ME</div>
      </div>

      <textarea id="input" placeholder="Opisz sytuacjƒô. Co siƒô sta≈Ço, co chcesz osiƒÖgnƒÖƒá, jakie masz ograniczenia?"></textarea>
      <button class="btn" id="analyzeBtn">Analiza ‚Üí</button>

      <div class="row">
        <button class="smallBtn primary" id="listenBtn">üéô S≈Çuchaj</button>
        <button class="smallBtn" id="speakBtn">üîä M√≥w</button>
        <button class="smallBtn" id="ambientBtn">üåå Ambient</button>
        <button class="smallBtn" id="stopBtn">‚èπ Stop</button>
      </div>

      <div class="chips">
        <div class="chip warn" id="modeChip">Tryb: DEMO (bez API)</div>
        <div class="chip good" id="pwaChip">PWA: ‚Äî</div>
        <div class="chip" id="voiceChip">Audio: ‚Äî</div>
        <div class="chip" id="verChip">Wersja: 20260223-HARDCORE</div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Analiza</h3>
          <p class="text" id="analysis">Tu pojawi siƒô analiza.</p>
        </div>
        <div class="card">
          <h3>Ryzyko</h3>
          <p class="text" id="risk">Tu pojawi siƒô ocena ryzyka.</p>
        </div>
        <div class="card">
          <h3>Rekomendacja</h3>
          <p class="text" id="recommendation">Tu pojawi siƒô rekomendacja.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="unlockOverlay" id="unlockOverlay" style="display:none;">
    <div class="unlockPanel">
      <p class="h">üîì Odblokuj d≈∫wiƒôk (iOS)</p>
      <p class="p">iPhone blokuje audio dop√≥ki nie dotkniesz ekranu. Kliknij raz ‚Äî uruchomiƒô ambient i test d≈∫wiƒôku.</p>
      <div class="urow">
        <button class="primary" id="unlockBtn">Odblokuj + Ambient</button>
        <button id="unlockNoAmbientBtn">Odblokuj bez ambientu</button>
      </div>
      <p class="p" style="margin-top:10px; opacity:0.85;">
        Tip: je≈õli nadal cisza ‚Äî sprawd≈∫ g≈Ço≈õno≈õƒá + czy nie leci na AirPods.
      </p>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);

const analyzeBtn = $("analyzeBtn");
const input = $("input");
const analysis = $("analysis");
const risk = $("risk");
const recommendation = $("recommendation");

const avatarBox = $("avatarBox");
const orbEl = $("orb");
const semiWrap = $("semiWrap");
const semiImg = $("semiImg");
const avatarPill = $("avatarPill");

const listenBtn = $("listenBtn");
const speakBtn = $("speakBtn");
const ambientBtn = $("ambientBtn");
const stopBtn = $("stopBtn");

const pwaChip = $("pwaChip");
const voiceChip = $("voiceChip");

const unlockOverlay = $("unlockOverlay");
const unlockBtn = $("unlockBtn");
const unlockNoAmbientBtn = $("unlockNoAmbientBtn");

function setVoiceChip(txt){ voiceChip.textContent = txt; }

function isStandalonePWA(){
  return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
}
function setPwaChip(){
  pwaChip.textContent = "PWA: " + (isStandalonePWA() ? "TAK" : "NIE");
}

/* ============ AVATAR MODE (ME vs others) ============ */
let meMode = localStorage.getItem("stan_me") === "1";
let avatar = localStorage.getItem("stan_avatar") || "orb";

if(meMode && !localStorage.getItem("stan_avatar_forced")){
  avatar = "semi";
}

function setAvatarPill(){
  if(avatar === "semi"){
    avatarPill.textContent = (meMode ? "Premium: SEMI-HUMAN (ME)" : "Premium: SEMI-HUMAN");
  } else {
    avatarPill.textContent = "Domy≈õlnie: ORB";
  }
  avatarPill.classList.toggle("me", meMode);
}

async function loadFirstImage(imgEl, candidates){
  for(const src of candidates){
    const ok = await new Promise((resolve)=>{
      const t = new Image();
      t.onload = ()=>resolve(true);
      t.onerror = ()=>resolve(false);
      t.src = src;
    });
    if(ok){ imgEl.src = src; return src; }
  }
  return null;
}

async function ensureSemiLoaded(){
  const candidates = [
    "avatar-semi.png",
    "avatar-semi.PNG",
    "avatar semi.PNG",
    "stan-semi-human.png"
  ];
  const src = await loadFirstImage(semiImg, candidates);
  if(!src){
    setVoiceChip("Avatar: brak pliku semi (wrzuƒá avatar-semi.png)");
    avatar = "orb";
  }
}

async function renderAvatar(){
  setAvatarPill();
  if(avatar === "semi"){
    await ensureSemiLoaded();
    orbEl.style.display = "none";
    semiWrap.style.display = "flex";
  } else {
    semiWrap.style.display = "none";
    orbEl.style.display = "block";
  }
}

function toggleAvatar(){
  avatar = (avatar === "orb") ? "semi" : "orb";
  localStorage.setItem("stan_avatar", avatar);
  localStorage.setItem("stan_avatar_forced", "1");
  renderAvatar();
}

let pressTimer1=null, pressTimer2=null;
function startPress(){
  clearTimeout(pressTimer1); clearTimeout(pressTimer2);
  pressTimer1 = setTimeout(()=>{ toggleAvatar(); }, 900);
  pressTimer2 = setTimeout(()=>{
    meMode = !meMode;
    localStorage.setItem("stan_me", meMode ? "1" : "0");
    localStorage.removeItem("stan_avatar_forced");
    avatar = meMode ? "semi" : "orb";
    localStorage.setItem("stan_avatar", avatar);
    renderAvatar();
    setVoiceChip(meMode ? "ME: ON (semi default)" : "ME: OFF (orb default)");
  }, 1900);
}
function endPress(){ clearTimeout(pressTimer1); clearTimeout(pressTimer2); }

avatarBox.addEventListener("touchstart", startPress, {passive:true});
avatarBox.addEventListener("touchend", endPress);
avatarBox.addEventListener("mousedown", startPress);
avatarBox.addEventListener("mouseup", endPress);
avatarBox.addEventListener("mouseleave", endPress);

/* Presence motion: follow pointer slightly */
let lastMoveAt = performance.now();
function setMotionFromEvent(e){
  const rect = avatarBox.getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width;
  const y = (e.clientY - rect.top) / rect.height;
  const mx = Math.max(-1, Math.min(1, (x - 0.5) * 2));
  const my = Math.max(-1, Math.min(1, (y - 0.5) * 2));
  document.documentElement.style.setProperty("--mx", mx.toFixed(3));
  document.documentElement.style.setProperty("--my", my.toFixed(3));
  lastMoveAt = performance.now();
}
avatarBox.addEventListener("pointermove", setMotionFromEvent);
avatarBox.addEventListener("touchmove", (ev)=>{
  if(ev.touches && ev.touches[0]){
    setMotionFromEvent({clientX: ev.touches[0].clientX, clientY: ev.touches[0].clientY});
  }
}, {passive:true});

function idleDrift(){
  const t = performance.now() / 1000;
  const idle = (performance.now() - lastMoveAt > 1200)
    ? (Math.sin(t*0.9)*0.6 + Math.sin(t*0.33)*0.4)
    : 0.12*Math.sin(t*0.7);
  document.documentElement.style.setProperty("--idle", idle.toFixed(3));
  requestAnimationFrame(idleDrift);
}
idleDrift();

/* ============ SPEAK (TTS) ============ */
const canSpeak = "speechSynthesis" in window;
function speak(text){
  if(!canSpeak){ setVoiceChip("Audio: brak speechSynthesis"); return; }
  try{ window.speechSynthesis.cancel(); }catch(e){}
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "pl-PL";
  u.rate = 1.03;
  u.pitch = 0.95;
  try{ window.speechSynthesis.speak(u); setVoiceChip("Audio: speak() OK"); }
  catch(e){ setVoiceChip("Audio: speak() ERROR"); }
}

/* ============ LISTEN (STT) ============ */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let listening = false;
const canListen = !!SpeechRecognition;

if(canListen){
  recognition = new SpeechRecognition();
  recognition.lang = "pl-PL";
  recognition.interimResults = false;
  recognition.continuous = false;

  recognition.onstart = ()=> {
    listening = true;
    listenBtn.textContent = "üéô S≈Çucham‚Ä¶";
    setVoiceChip("Mikrofon: ON");
  };
  recognition.onresult = (e)=> {
    const t = e.results?.[0]?.[0]?.transcript || "";
    if(t) input.value = t;
  };
  recognition.onerror = (e)=> { setVoiceChip("Mikrofon: ERROR (" + (e.error || "unknown") + ")"); };
  recognition.onend = ()=> {
    listening = false;
    listenBtn.textContent = "üéô S≈Çuchaj";
    setVoiceChip("Mikrofon: OFF");
  };
}

/* ============ AMBIENT (WebAudio hardcore unlock) ============ */
let audioCtx=null, masterGain=null, ambientOn=false, unlocked=false;

function initAmbient(){
  if(audioCtx) return;
  const Ctx = window.AudioContext || window.webkitAudioContext;
  if(!Ctx){ setVoiceChip("Audio: brak WebAudio"); return; }

  audioCtx = new Ctx();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = 0.0;
  masterGain.connect(audioCtx.destination);

  // noise bed
  const noiseBuf = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
  const data = noiseBuf.getChannelData(0);
  for(let i=0;i<data.length;i++) data[i] = (Math.random()*2 - 1) * 0.25;

  const noise = audioCtx.createBufferSource();
  noise.buffer = noiseBuf;
  noise.loop = true;

  const noiseFilter = audioCtx.createBiquadFilter();
  noiseFilter.type = "lowpass";
  noiseFilter.frequency.value = 850;
  noiseFilter.Q.value = 0.7;

  const noiseGain = audioCtx.createGain();
  noiseGain.gain.value = 0.25;

  noise.connect(noiseFilter);
  noiseFilter.connect(noiseGain);
  noiseGain.connect(masterGain);
  noise.start();

  // low hum
  const hum = audioCtx.createOscillator();
  hum.type = "sine";
  hum.frequency.value = 52;

  const humGain = audioCtx.createGain();
  humGain.gain.value = 0.16;

  hum.connect(humGain);
  humGain.connect(masterGain);
  hum.start();

  // movement
  const lfo = audioCtx.createOscillator();
  lfo.type = "sine";
  lfo.frequency.value = 0.07;

  const lfoGain = audioCtx.createGain();
  lfoGain.gain.value = 160;
  lfo.connect(lfoGain);
  lfoGain.connect(noiseFilter.frequency);
  lfo.start();
}

async function unlockAudio({autoAmbient}){
  initAmbient();
  if(!audioCtx){ unlockOverlay.style.display = "none"; return; }

  try{ if(audioCtx.state !== "running") await audioCtx.resume(); }catch(e){}

  // test beep
  try{
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = 220;
    g.gain.value = 0.0001;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.035, t + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.14);
    o.stop(t + 0.16);
  }catch(e){}

  unlocked = true;
  setVoiceChip("Audio: unlocked (ctx=" + audioCtx.state + ")");
  if(autoAmbient) setAmbient(true);
  unlockOverlay.style.display = "none";
}

function setAmbient(on){
  initAmbient();
  if(!audioCtx || !masterGain){ setVoiceChip("Audio: brak ambient"); return; }

  ambientOn = on;
  const t = audioCtx.currentTime;
  masterGain.gain.cancelScheduledValues(t);

  const base = 0.060; // audible on phone
  if(on){
    masterGain.gain.linearRampToValueAtTime(base, t + 0.55);
    setVoiceChip("üåå Ambient: ON (ctx=" + audioCtx.state + ")");
    ambientBtn.textContent = "üåå Ambient: ON";
  } else {
    masterGain.gain.linearRampToValueAtTime(0.0, t + 0.35);
    setVoiceChip("üåå Ambient: OFF (ctx=" + audioCtx.state + ")");
    ambientBtn.textContent = "üåå Ambient";
  }
}

function stopAllAudio(){
  try{ if(canSpeak) window.speechSynthesis.cancel(); }catch(e){}
  try{ if(recognition && listening) recognition.stop(); }catch(e){}
  try{ setAmbient(false); }catch(e){}
  setVoiceChip("Audio: STOP");
}

function showUnlockOverlay(){ unlockOverlay.style.display = "flex"; }

function firstGestureUnlockHandler(){
  if(unlocked) return;
  unlockAudio({autoAmbient:true});
  window.removeEventListener("pointerdown", firstGestureUnlockHandler, true);
  window.removeEventListener("touchstart", firstGestureUnlockHandler, true);
  window.removeEventListener("keydown", firstGestureUnlockHandler, true);
}

/* ============ STAN CORE (DEMO, hardcore tone) ============ */
function stanDemo(text){
  const t = (text || "").trim();
  const opening =
    "Dobra. Zatrzymajmy chaos na chwilƒô i z≈Çapmy fakty.\n" +
    "Brakuje mi konkret√≥w ‚Äî wiƒôc dopytam. Nie bƒôdƒô wr√≥≈ºyƒá. Bƒôdƒô mierzyƒá.\n\n";

  if(t.length < 40){
    return {
      analysis: opening +
        "Masz za ma≈Ço danych.\n\nPodaj 3 rzeczy:\n" +
        "1) Cel (co ma byƒá inne po tej decyzji?)\n" +
        "2) Ograniczenia (czas/pieniƒÖdze/relacje/zdrowie)\n" +
        "3) Stawka (co tracisz, je≈õli zrobisz ≈∫le?)\n\n" +
        "Je≈õli nie dopiszesz ‚Äî nie analizujƒô, bo to by≈Çoby zgadywanie.",
      risk: "Ryzyko: zgadywanie + emocje.\nOcena: wysokie.\nUtnij decyzje podejmowane ‚Äûw szczycie‚Äù.",
      recommendation:
        "Plan na teraz:\n" +
        "‚Äî Dopisz 3 punkty powy≈ºej.\n" +
        "‚Äî Potem ja zrobiƒô: opcje A/B/C + konsekwencje.\n" +
        "‚Äî Je≈õli odm√≥wisz konkret√≥w: stop (to nie jest wr√≥≈ºenie)."
    };
  }

  const hasTime = /(dzi≈õ|jutro|tydzie≈Ñ|miesiƒÖc|do|deadline|data)/i.test(t);
  const hasConstraints = /(nie mogƒô|muszƒô|bud≈ºet|czas|dziecko|praca|zdrow)/i.test(t);

  let a = "üîé ANALIZA\n\n" +
    "Fakty > emocje.\n" +
    "To, ≈ºe co≈õ boli, nie znaczy, ≈ºe jest strategiczne.\n\n" +
    "Sprawd≈∫:\n" +
    "‚Äî Co jest mierzalne?\n" +
    "‚Äî Co jest tylko reakcjƒÖ?\n\n";

  a += hasConstraints
    ? "Masz ograniczenia ‚Äî dobrze. One wyznaczajƒÖ realne opcje.\n"
    : "Nie widzƒô ogranicze≈Ñ. Bez tego plan bƒôdzie fikcjƒÖ.\n";

  a += hasTime
    ? "Jest kontekst czasu. Da siƒô zrobiƒá plan.\n"
    : "Nie poda≈Ça≈õ horyzontu czasu. Decyzja bez czasu = rozmycie.\n";

  const r = "‚ö†Ô∏è RYZYKO\n\n" +
    "Ryzyko #1: decyzja w emocjach.\n" +
    "Ryzyko #2: brak kryteri√≥w (potem ≈ºal + chaos).\n\n" +
    "Zasada: najpierw regulacja. Potem ruch.";

  const rec = "üéØ REKOMENDACJA\n\n" +
    "Plan 7 dni:\n" +
    "‚Äî Zapisz 3 kryteria decyzji (co ma siƒô poprawiƒá?).\n" +
    "‚Äî Zr√≥b 1 mikro-test (ma≈Çy ruch bez spalenia most√≥w).\n" +
    "‚Äî Oce≈Ñ wynik na skali 1‚Äì10.\n\n" +
    "Plan 30 dni:\n" +
    "‚Äî Wybierz kierunek i go dowie≈∫.\n" +
    "‚Äî Zablokuj powr√≥t do punktu 0 (bez ruminacji).\n" +
    "‚Äî Iteruj zamiast panikowaƒá.\n\n" +
    "Chcesz: ja sam zaproponujƒô opcje A/B/C. Ale najpierw: kryteria.";

  return {analysis:a, risk:r, recommendation:rec};
}

function run(){
  const t = (input.value || "").trim();
  const out = stanDemo(t);
  analysis.textContent = out.analysis;
  risk.textContent = out.risk;
  recommendation.textContent = out.recommendation;
  if(unlocked) speak(out.recommendation);
}

/* ============ EVENTS ============ */
analyzeBtn.addEventListener("click", ()=>{
  if(!unlocked) showUnlockOverlay();
  run();
});

listenBtn.addEventListener("click", ()=>{
  if(!canListen){
    setVoiceChip("Mikrofon: BRAK (iOS PWA czƒôsto blokuje)");
    alert("iOS/PWA czƒôsto nie wspiera rozpoznawania mowy w Safari. Fallback: wpisz tekst lub zrobimy nagranie i transkrypcjƒô p√≥≈∫niej.");
    return;
  }
  try{ listening ? recognition.stop() : recognition.start(); }
  catch(e){ setVoiceChip("Mikrofon: ERROR (start/stop)"); }
});

speakBtn.addEventListener("click", ()=>{
  if(!unlocked) showUnlockOverlay();
  const t = [analysis.textContent, risk.textContent, recommendation.textContent].join("\n\n");
  speak(t);
});

ambientBtn.addEventListener("click", ()=>{
  if(!unlocked){ showUnlockOverlay(); return; }
  setAmbient(!ambientOn);
});

stopBtn.addEventListener("click", stopAllAudio);

unlockBtn.addEventListener("click", ()=> unlockAudio({autoAmbient:true}));
unlockNoAmbientBtn.addEventListener("click", ()=> unlockAudio({autoAmbient:false}));

window.addEventListener("pointerdown", firstGestureUnlockHandler, true);
window.addEventListener("touchstart", firstGestureUnlockHandler, true);
window.addEventListener("keydown", firstGestureUnlockHandler, true);

/* init */
setPwaChip();
renderAvatar();

setTimeout(()=>{
  if(!unlocked) showUnlockOverlay();
  setVoiceChip("Audio: locked (tap to unlock)");
}, 350);
</script>
</body>
</html>