<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>STAN</title>

  <meta name="theme-color" content="#0B0F1A" />
  <link rel="manifest" href="manifest.json" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="STAN" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root{
      --bg:#070A12; --bg2:#0B0F1A;
      --surface: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.10);
      --text:#EAF0FF;
      --muted: rgba(234,240,255,0.72);
      --muted2: rgba(234,240,255,0.55);
      --a1:#7B5CFF; --a2:#B256FF;
      --good:#45D483; --warn:#F0C04A;
      --r: 22px;
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 65% 18%, rgba(123,92,255,0.23), transparent 55%),
        radial-gradient(900px 520px at 22% 70%, rgba(178,86,255,0.16), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      padding: 22px 16px 40px;
      padding-top: max(22px, env(safe-area-inset-top));
      padding-bottom: max(40px, env(safe-area-inset-bottom));
    }
    .wrap{ max-width:560px; margin:0 auto; }
    .title{ font-size:56px; line-height:0.95; font-weight:800; letter-spacing:-0.02em; margin:10px 0 8px; }
    .subtitle{ margin:0 0 18px; color:var(--muted2); font-size:18px; }

    .hero{
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow: hidden;
      padding: 16px;
    }

    .avatarBox{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: calc(var(--r) - 6px);
      border: 1px solid rgba(255,255,255,0.12);
      background:
        radial-gradient(650px 420px at 50% 40%, rgba(123,92,255,0.22), rgba(0,0,0,0) 55%),
        radial-gradient(800px 520px at 50% 110%, rgba(178,86,255,0.14), rgba(0,0,0,0) 60%),
        rgba(0,0,0,0.22);
      position: relative;
      overflow:hidden;
      margin-bottom:14px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* ORB (CSS, always works) */
    .orb{
      width:72%; aspect-ratio:1/1; border-radius:999px; position:relative;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,0.34), rgba(255,255,255,0.06) 22%, rgba(0,0,0,0) 45%),
        radial-gradient(circle at 50% 55%, rgba(178,86,255,0.38), rgba(123,92,255,0.22) 40%, rgba(0,0,0,0) 70%),
        radial-gradient(circle at 50% 50%, rgba(90,70,255,0.25), rgba(0,0,0,0) 72%),
        radial-gradient(circle at 50% 50%, rgba(0,0,0,0.55), rgba(0,0,0,0.0) 60%);
      box-shadow:
        0 0 80px rgba(123,92,255,0.35),
        0 0 140px rgba(178,86,255,0.20),
        inset 0 0 35px rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.12);
    }
    .orb:after{
      content:"";
      position:absolute; left:-10%; right:-10%; top:48%;
      height:3px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.75), transparent);
      box-shadow: 0 0 18px rgba(178,86,255,0.55);
      opacity:0.9;
    }

    textarea{
      width:100%; min-height:112px; resize: vertical;
      border-radius:18px; border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.22);
      color: var(--text); padding: 14px;
      font-size: 16px; line-height: 1.35;
      outline: none;
    }
    textarea::placeholder{ color: rgba(234,240,255,0.45); }

    .btn{
      width:100%; margin-top:12px;
      border:none; border-radius:18px;
      padding:16px 18px;
      font-size:20px; font-weight:800; color:white;
      background: linear-gradient(90deg, var(--a1), var(--a2));
      box-shadow: 0 18px 50px rgba(123,92,255,0.22);
      cursor:pointer;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }

    .row{
      display:flex; gap:10px; margin-top:10px;
    }
    .smallBtn{
      flex:1;
      border-radius:16px;
      padding:12px 14px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(234,240,255,0.85);
      font-weight:800;
      cursor:pointer;
    }
    .smallBtn.primary{
      background: linear-gradient(90deg, rgba(123,92,255,0.40), rgba(178,86,255,0.35));
      border-color: rgba(255,255,255,0.14);
    }

    .chips{
      margin-top: 12px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .chip{
      font-size:13px; color: rgba(234,240,255,0.70);
      padding: 9px 12px; border-radius:999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
      backdrop-filter: blur(10px);
    }
    .chip.good{ border-color: rgba(69,212,131,0.35); color: rgba(69,212,131,0.95); }
    .chip.warn{ border-color: rgba(240,192,74,0.35); color: rgba(240,192,74,0.95); }

    .grid{ margin-top:16px; display:grid; gap:12px; }
    .card{
      border-radius:20px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
      padding:16px;
    }
    .card h3{ margin:0 0 8px; font-size:34px; letter-spacing:-0.02em; }
    .card .text{
      margin:0;
      color: rgba(234,240,255,0.74);
      font-size:16px;
      line-height:1.42;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">STAN</div>
    <div class="subtitle">Agent decyzyjny AI</div>

    <div class="hero">
      <div class="avatarBox" id="avatarBox">
        <div class="orb" aria-label="STAN orb"></div>
      </div>

      <textarea id="input" placeholder="Opisz sytuacjƒô. Co siƒô sta≈Ço? Co chcesz osiƒÖgnƒÖƒá? Jakie masz ograniczenia?"></textarea>

      <button class="btn" id="analyzeBtn">Analiza ‚Üí</button>

      <div class="row">
        <button class="smallBtn primary" id="listenBtn">üéôÔ∏è S≈Çuchaj</button>
        <button class="smallBtn" id="speakBtn">üîä M√≥w</button>
        <button class="smallBtn" id="stopBtn">‚èπ Stop</button>
      </div>

      <div class="chips">
        <div class="chip warn" id="modeChip">Tryb: DEMO (bez API)</div>
        <div class="chip good" id="pwaChip">PWA: ‚Ä¶</div>
        <div class="chip" id="voiceChip">G≈Ços: ‚Ä¶</div>
        <div class="chip" id="verChip">Wersja: 20260223-VOICE-01</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Analiza</h3>
        <p class="text" id="analysis">Tu pojawi siƒô analiza.</p>
      </div>

      <div class="card">
        <h3>Ryzyko</h3>
        <p class="text" id="risk">Tu pojawi siƒô ocena ryzyka.</p>
      </div>

      <div class="card">
        <h3>Rekomendacja</h3>
        <p class="text" id="recommendation">Tu pojawi siƒô rekomendacja.</p>
      </div>
    </div>
  </div>

<script>
  // ===== PWA detect =====
  function isStandalonePWA(){
    return window.matchMedia("(display-mode: standalone)").matches
        || window.navigator.standalone === true;
  }
  function setPwaChip(){
    document.getElementById("pwaChip").textContent = "PWA: " + (isStandalonePWA() ? "TAK" : "NIE");
  }

  // ===== Voice: Speech Synthesis (m√≥wienie) =====
  const canSpeak = "speechSynthesis" in window && "SpeechSynthesisUtterance" in window;
  let speakingUtterance = null;

  function speak(text){
    if(!canSpeak){
      document.getElementById("voiceChip").textContent = "G≈Ços: m√≥wienie ‚Äì BRAK";
      return;
    }
    window.speechSynthesis.cancel();

    const u = new SpeechSynthesisUtterance(text);
    u.lang = "pl-PL";
    u.rate = 1.03;   // minimalnie szybciej
    u.pitch = 0.95;  // minimalnie ni≈ºej
    speakingUtterance = u;

    window.speechSynthesis.speak(u);
  }

  function stopAllAudio(){
    if(canSpeak) window.speechSynthesis.cancel();
    if(recognition) { try { recognition.stop(); } catch(e){} }
  }

  // ===== Voice: Speech Recognition (s≈Çuchanie) =====
  // Na iOS bywa niedostƒôpne. Gdy brak ‚Äì poka≈ºemy komunikat.
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const canListen = !!SR;
  let recognition = null;
  let listening = false;

  if(canListen){
    recognition = new SR();
    recognition.lang = "pl-PL";
    recognition.continuous = false;
    recognition.interimResults = true;

    recognition.onstart = () => {
      listening = true;
      document.getElementById("voiceChip").textContent = "G≈Ços: s≈Çucham‚Ä¶";
    };

    recognition.onresult = (event) => {
      let finalText = "";
      let interim = "";
      for (let i = event.resultIndex; i < event.results.length; i++){
        const txt = event.results[i][0].transcript;
        if(event.results[i].isFinal) finalText += txt;
        else interim += txt;
      }
      const box = document.getElementById("input");
      if(finalText) box.value = (box.value ? box.value + " " : "") + finalText.trim();
      else if(interim) {
        // delikatny podglƒÖd: dopisujemy w placeholder? (nie ruszamy tekstu)
      }
    };

    recognition.onerror = () => {
      document.getElementById("voiceChip").textContent = "G≈Ços: s≈Çuchanie ‚Äì b≈ÇƒÖd/blocked";
      listening = false;
    };

    recognition.onend = () => {
      listening = false;
      document.getElementById("voiceChip").textContent = "G≈Ços: gotowe";
    };
  }

  // ===== STAN DEMO ‚Äûinteligencja‚Äù =====
  function normalize(s){ return (s || "").toString().trim(); }

  function detectTopic(text){
    const t = text.toLowerCase();
    const rel = ["partner","zwiƒÖzek","relacja","rozst","k≈Ç√≥tn","zdrad","obra≈ºa","ucieka"];
    const work = ["praca","szef","firma","projekt","biznes","zarab","etat","klient"];
    const money = ["kasa","pieniƒÖdz","kredyt","rata","czynsz","d≈Çug","bud≈ºet","oszcz"];
    const health = ["zdrow","sen","lƒôk","panik","depres","psych","b√≥l","terapi"];
    const score = (arr)=>arr.reduce((a,w)=>a+(t.includes(w)?1:0),0);
    const m = {rel:score(rel), work:score(work), money:score(money), health:score(health)};
    let top="og√≥lne", best=0;
    for (const k in m){ if(m[k]>best){best=m[k]; top=k;} }
    return top;
  }

  function extractConstraints(text){
    const t=text.toLowerCase();
    const hits=[];
    if (t.match(/\b(7 dni|tydzie≈Ñ|30 dni|miesiƒÖc|jutro|dzi≈õ|deadline)\b/)) hits.push("czas");
    if (t.match(/\b(pieniƒÖdz|kasa|bud≈ºet|kredyt|rata|czynsz|brak dochodu|oszczƒôd)\b/)) hits.push("pieniƒÖdze");
    if (t.match(/\b(zdrow|sen|lƒôk|atak paniki|terapi|lekarz)\b/)) hits.push("zdrowie");
    return [...new Set(hits)];
  }

  function proposeOptions(topic){
    if (topic==="rel") return [
      "A) Rozmowa z ramƒÖ + granica: 1 temat, 1 pro≈õba, 1 konsekwencja.",
      "B) Reset: pauza 48h + spis fakt√≥w + rozmowa w neutralnym miejscu."
    ];
    if (topic==="work") return [
      "A) Bezpieczny marsz: zostajesz w pracy i robisz MVP z limitem czasu.",
      "B) Skok kontrolowany: runway 3‚Äì6 mies. ‚Üí dopiero redukcja etatu/zmiana."
    ];
    if (topic==="money") return [
      "A) Stabilizacja: tniesz koszty sta≈Çe, porzƒÖdkujesz przep≈Çywy.",
      "B) Ofensywa: zwiƒôkszasz przych√≥d + plan sp≈Çat z terminami."
    ];
    if (topic==="health") return [
      "A) Ulga 7 dni: sen + rutyna + redukcja bod≈∫c√≥w.",
      "B) Plan 30 dni: konsultacja + system (sen/ruch/wsparcie)."
    ];
    return [
      "A) Wariant bezpieczny: ma≈Çe kroki + test fakt√≥w.",
      "B) Wariant ofensywny: szybciej, ale z barierkami (limity/konsekwencje)."
    ];
  }

  function stanDemo(text){
    const topic = detectTopic(text);
    const constraints = extractConstraints(text);

    const opening = [
      "Dobra. Zatrzymajmy chaos na chwilƒô i z≈Çapmy fakty.",
      "Nie bƒôdƒô mi≈Ça. Bƒôdƒô pomocna.",
      "Plan po konkretach albo odmowa."
    ].join(" ");

    const missing=[];
    if (text.length < 35) missing.push("opis jest za kr√≥tki");
    if (constraints.length === 0) missing.push("brak twardych ogranicze≈Ñ (czas/pieniƒÖdze/zdrowie)");
    const needsClarify = missing.length>0;

    const opt = proposeOptions(topic);

    if (needsClarify){
      return {
        analysis:
          opening + "\n\n" +
          "Widzƒô kierunek, ale brakuje danych: " + missing.join(", ") + ".\n" +
          "Temat: " + (topic==="rel"?"relacja":topic==="work"?"praca/projekt":topic==="money"?"finanse":topic==="health"?"zdrowie":"decyzja og√≥lna") + ".",
        risk:
          "Ryzyko: decyzja w emocjach + interpretacja bez ram.\n" +
          "Ocena: ≈õrednie‚Äìwysokie dop√≥ki nie doprecyzujesz fakt√≥w.",
        recommendation:
          "Odpowiedz kr√≥tko:\n" +
          "1) Twarde ograniczenia (czas/kasa/zdrowie) ‚Äì 1 linia.\n" +
          "2) Cel na 30 dni ‚Äì 1 zdanie.\n\n" +
          "Proponowane opcje (do potwierdzenia):\n" +
          opt.map(x=>"‚Ä¢ "+x).join("\n")
      };
    }

    return {
      analysis:
        opening + "\n\n" +
        "Ograniczenia wykryte: " + constraints.join(", ") + ".\n" +
        "Masz napiƒôcie miƒôdzy bezpiecze≈Ñstwem a zmianƒÖ. Normalne.\n" +
        "Twoim problemem nie jest lƒôk. Problemem jest brak struktury decyzji.",
      risk:
        "Ryzyko #1: decyzja w szczycie emocji.\n" +
        "Ryzyko #2: przeciƒÖganie = te≈º decyzja.\n" +
        "Ocena: ≈õrednie ‚Äî da siƒô zbiƒá ramƒÖ.",
      recommendation:
        "Wybieramy jednƒÖ opcjƒô i testujemy w rzeczywisto≈õci.\n\n" +
        "Opcje:\n" + opt.map(x=>"‚Ä¢ "+x).join("\n") + "\n\n" +
        "Teraz wyb√≥r: A czy B? (jedna litera).\n" +
        "Je≈õli nie umiesz: napisz, czego bardziej boisz siƒô straciƒá (1 zdanie)."
    };
  }

  async function run(){
    const text = normalize(document.getElementById("input").value);
    const out = stanDemo(text);
    document.getElementById("analysis").textContent = out.analysis;
    document.getElementById("risk").textContent = out.risk;
    document.getElementById("recommendation").textContent = out.recommendation;

    // auto-m√≥wienie (opcjonalne): STAN m√≥wi rekomendacjƒô
    speak(out.recommendation);
  }

  document.getElementById("analyzeBtn").addEventListener("click", run);

  document.getElementById("listenBtn").addEventListener("click", ()=>{
    if(!canListen){
      document.getElementById("voiceChip").textContent =
        "G≈Ços: s≈Çuchanie ‚Äì BRAK (iOS PWA czƒôsto blokuje). U≈ºyj dyktowania klawiatury.";
      return;
    }
    if(listening){ try{ recognition.stop(); }catch(e){} return; }
    try{ recognition.start(); }catch(e){
      document.getElementById("voiceChip").textContent = "G≈Ços: s≈Çuchanie ‚Äì nie mogƒô uruchomiƒá";
    }
  });

  document.getElementById("speakBtn").addEventListener("click", ()=>{
    const t = [
      document.getElementById("analysis").textContent,
      document.getElementById("risk").textContent,
      document.getElementById("recommendation").textContent
    ].join("\n\n");
    speak(t);
  });

  document.getElementById("stopBtn").addEventListener("click", stopAllAudio);

  // init
  setPwaChip();
  document.getElementById("voiceChip").textContent =
    "G≈Ços: " + (canListen ? "s≈Çuchanie+ m√≥wienie" : (canSpeak ? "m√≥wienie" : "brak"));
</script>
</body>
</html>